<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budgetplaner</title>
  <style>
    :root{--bg:#0b0b0f;--card:#16171d;--muted:#8e95a1;--text:#e8eaed;--primary:#0a84ff;--danger:#ff4d4f;--ok:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:320px 1fr}}
    .card{background:var(--card);border:1px solid #24262e;border-radius:14px;padding:16px}
    h1{font-size:22px;margin:0 0 12px}
    h2{font-size:16px;margin:0 0 8px;color:var(--muted)}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2d36;background:#0e0f14;color:var(--text);pointer-events:auto}
    input[type="month"], input[type="date"]{padding:8px 10px}
    button{background:var(--primary);border:none;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px dashed #2a2d36}
    .row{display:flex;gap:10px}
    .row>div{flex:1}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #23252e;text-align:left;font-size:14px}
    th{color:#aab2c0;font-weight:600}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px}
    .pill.in{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.3)}
    .pill.out{background:rgba(255,77,79,.12);color:#ffb4b5;border:1px solid rgba(255,77,79,.3)}
    .sum{font-size:28px;font-weight:700}
    .sum.positive{color:#86efac}
    .sum.negative{color:#ff9aa0}
    .hide{display:none}
    .auth{max-width:420px;margin:96px auto}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px}
    .tag{padding:6px 10px;border-radius:10px;background:#0e0f14;border:1px solid #2a2d36;color:#9aa2b2;font-size:12px}
    .actions{display:flex;gap:8px}

    /* === Mobile Optimierungen === */
    /* 1) Größere Touch-Ziele */
    @media(max-width:600px){
      button{padding:14px 16px;font-size:16px}
      input,select,textarea{padding:12px 14px;font-size:16px}
    }

    /* 2) Formular untereinander stapeln */
    @media(max-width:500px){
      .row{flex-direction:column}
    }

    /* 3) Topbar/Aktionen umbrechen */
    @media(max-width:700px){
      .topbar{flex-direction:column;align-items:stretch}
      .actions{flex-direction:column;width:100%}
      .actions > *{width:100%}
    }

    /* 4) Tabelle als Kartenliste auf Mobilgeräten */
    @media(max-width:600px){
      table, thead, tbody, th, td, tr { display:block; }
      thead{ display:none; }
      tbody{ display:grid; gap:10px; }
      tr{ border:1px solid #23252e; border-radius:12px; padding:8px; }
      td{ border:none; padding:8px 8px; }
      td[data-label]{
        display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      }
      td[data-label]::before{
        content: attr(data-label);
        font-weight:600; color:var(--muted);
      }
      td:last-child{ padding-top:8px }
      .right{ justify-content:stretch }
      .right button{ flex:1 }
      /* Betrag in eigener Zeile rechtsbündig */
      td.amount{ font-variant-numeric: tabular-nums; }
    }

    .cat-breakdown{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .cat-chip{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background:#0e0f14;
      border:1px solid #2a2d36;
      color:var(--muted);
      font-variant-numeric: tabular-nums;
      cursor:pointer;
      user-select:none;
      transition:background .15s,border-color .15s,transform .1s;
    }
    .cat-chip:hover{
      border-color:var(--primary);
      transform:translateY(-1px);
    }
    .cat-chip.active{
      background:#111827;
      border-color:var(--primary);
      color:#e5e7eb;
    }
    .cat-details{
      margin-top:10px;
      border-top:1px dashed #2a2d36;
      padding-top:10px;
      font-size:13px;
    }
    .cat-details-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      color:var(--muted);
    }
    .cat-details-list{
      display:grid;
      gap:4px;
    }
    .cat-details-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      border-radius:8px;
      padding:4px 6px;
      background:#0b0c12;
    }
    .cat-details-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .cat-details-amount{
      font-variant-numeric:tabular-nums;
    }

  </style>
</head>
<body>
  <div id="auth" class="wrap auth">
    <div class="card">
      <h1>Anmeldung</h1>
      <div style="display:grid;gap:8px">
        <input id="email" type="email" placeholder="E‑Mail" />
        <input id="password" type="password" placeholder="Passwort" />
        <div class="row">
          <button id="loginBtn">Anmelden</button>
          <button id="signupBtn" class="ghost">Registrieren</button>
        </div>
        <div id="auth-error" class="muted" style="min-height:22px"></div>
      </div>
    </div>
  </div>

  <div id="app" class="wrap hide">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:10px">
        <h1 style="margin:0">Budgetplaner</h1>
        <span id="who" class="tag"></span>
      </div>
      <div class="actions">
        <input id="month" type="month"/>
        <button id="exportBtn" title="CSV Export">Export</button>
        <button id="logout">Abmelden</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Eintrag</h2>
        <div class="row">
          <div>
            <label class="muted">Datum</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label class="muted">Typ</label>
            <select id="kind">
              <option value="income">Einnahme</option>
              <option value="expense">Ausgabe</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label class="muted">Kategorie</label>
            <select id="cat">
              <option value="">Kategorie wählen…</option>
              <option value="Arbeit">Arbeit</option>
              <option value="Essen">Essen</option>
              <option value="Sparen">Sparen</option>
              <option value="Bücher">Bücher</option>
              <option value="Shoppen">Shoppen</option>
              <option value="Sonstiges">Sonstiges</option>
              <option value="Miete">Miete</option>
              <option value="Gesundheit">Gesundheit</option>
            </select>
          </div>
          <div>
            <label class="muted">Betrag (€)</label>
            <input id="amount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0,00" />
          </div>
        </div>
        <div>
          <label class="muted">Notiz</label>
          <input id="note" placeholder="optional" />
        </div>
        <div class="row">
          <button id="save">Hinzufügen</button>
          <button id="cancelEdit" class="ghost hide">Abbrechen</button>
        </div>
        <div id="form-error" class="muted" style="min-height:22px"></div>
      </div>

      <div class="card">
        <h2>Übersicht</h2>
        <div class="row">
          <div class="card" style="flex:1">
            <div class="muted">Einnahmen</div>
            <div id="sumIn" class="sum">–</div>
          </div>
          <div class="card" style="flex:1">
            <div class="muted">Ausgaben</div>
            <div id="sumOut" class="sum">–</div>
          </div>
          <div class="card" style="flex:1">
            <div class="muted">Saldo</div>
            <div id="sumNet" class="sum">–</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Ausgaben nach Kategorie (dieser Monat)</div>
          <div id="catBreakdown" class="cat-breakdown"></div>
          <div id="catDetails" class="cat-details"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Buchungen</h2>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Typ</th>
              <th>Kategorie</th>
              <th style="text-align:right">Betrag</th>
              <th>Notiz</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, Timestamp, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // === Firebase config (unverändert) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBX2SJ69fysC6EhhAUr-RhnwLUz7OvP1Nc",
      authDomain: "budgetyve.firebaseapp.com",
      projectId: "budgetyve",
      storageBucket: "budgetyve.appspot.com",
      messagingSenderId: "675773555711",
      appId: "1:675773555711:web:3f2c7a7bf7ac5d6a507dca"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === Helpers ===
    const $ = (id)=>document.getElementById(id);
    const fmtEUR = (n)=> new Intl.NumberFormat('de-DE',{ style:'currency', currency:'EUR' }).format(n);
    const todayISO = ()=> new Date().toISOString().slice(0,10);
    const monthOf = (date)=> date.toISOString().slice(0,7); // YYYY-MM

    let unsub = null; // active snapshot listener
    let editId = null; // currently edited doc id

    function setForm(data){
      $("date").value = data?.date || todayISO();
      $("kind").value = data?.kind || 'expense';
      $("cat").value  = data?.cat  || '';
      $("amount").value = data?.amount != null ? String(data.amount) : '';
      $("note").value = data?.note || '';
      $("form-error").textContent = '';
    }

    function setModeEditing(enabled){
      $("save").textContent = enabled ? 'Speichern' : 'Hinzufügen';
      $("cancelEdit").classList.toggle('hide', !enabled);
    }

    function monthStartEnd(yyyyMM){
      const [y,m] = yyyyMM.split('-').map(Number);
      const start = new Date(Date.UTC(y, m-1, 1, 0,0,0));
      const end   = new Date(Date.UTC(y, m,   1, 0,0,0)); // exclusive
      return { start: Timestamp.fromDate(start), end: Timestamp.fromDate(end) };
    }

    function rowTemplate(d){
      const date = d.date?.toDate?.() || new Date(d.date);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Datum">${date.toLocaleDateString('de-DE')}</td>
        <td data-label="Typ">${d.kind==='income' ? '<span class="pill in">Einnahme</span>' : '<span class="pill out">Ausgabe</span>'}</td>
        <td data-label="Kategorie">${escapeHtml(d.cat || '')}</td>
        <td data-label="Betrag" class="amount" style="text-align:right">${fmtEUR(Number(d.amount||0))}</td>
        <td data-label="Notiz">${escapeHtml(d.note || '')}</td>
        <td data-label="Aktionen" class="right">
          <button data-act="edit">Bearbeiten</button>
          <button data-act="del" style="background:var(--danger)">Löschen</button>
        </td>`;
      return tr;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    async function saveEntry(uid){
      const date = $("date").value;
      const kind = $("kind").value;
      const cat  = $("cat").value.trim();
      const amount = Number($("amount").value);
      const note = $("note").value.trim();

      if(!date || !cat || !Number.isFinite(amount) || amount < 0){
        $("form-error").textContent = 'Bitte Datum, Kategorie und einen Betrag ≥ 0 angeben.';
        return;
      }

      const data = {
        date: Timestamp.fromDate(new Date(date + 'T12:00:00Z')), // mittags: TZ-sicher
        kind, cat, amount, note,
        updatedAt: serverTimestamp(),
        month: date.slice(0,7), // für einfache Filter/Indexe
      };

      const col = collection(db, 'users', uid, 'entries');

      if(editId){
        await updateDoc(doc(col, editId), data);
        editId = null;
        setModeEditing(false);
      } else {
        await addDoc(col, { ...data, createdAt: serverTimestamp() });
      }
      setForm();
    }

    async function deleteEntry(uid, id){
      const col = collection(db, 'users', uid, 'entries');
      await deleteDoc(doc(col, id));
    }

    
    function renderCategoryTotals(catTotals, catEntries){
      const container = $("catBreakdown");
      const details = $("catDetails");
      if(!container || !details) return;

      container.innerHTML = '';
      details.innerHTML = '';

      const allowed = [
        'Arbeit',
        'Essen',
        'Sparen',
        'Bücher',
        'Shoppen',
        'Sonstiges',
        'Miete',
        'Gesundheit'
      ];

      const hasAny = allowed.some(cat => (catTotals[cat] || 0) > 0);
      if(!hasAny){
        container.innerHTML = '<span class="muted">Keine Ausgaben in diesem Monat.</span>';
        return;
      }

      const renderDetailsFor = (cat)=>{
        const list = catEntries[cat] || [];
        if(!list.length){
          details.innerHTML = '';
          return;
        }
        const total = catTotals[cat] || 0;
        const frag = document.createElement('div');
        frag.innerHTML = `
          <div class="cat-details-header">
            <span>${escapeHtml(cat)} – ${list.length} Buchung(en)</span>
            <span class="cat-details-amount">${fmtEUR(total)}</span>
          </div>
          <div class="cat-details-list"></div>
        `;
        const listEl = frag.querySelector('.cat-details-list');
        list.forEach(item=>{
          const date = item.date?.toDate?.() || new Date(item.date);
          
          const row = document.createElement('div');
          row.className = 'cat-details-row';
          const note = (item.note || '').trim();
          row.innerHTML = `
            <div style="display:flex; gap:12px; align-items:center;">
              <span>${date.toLocaleDateString('de-DE')}</span>
              ${note ? `<span class="muted">Notiz: ${escapeHtml(note)}</span>` : ''}
            </div>
            <div class="cat-details-amount">${fmtEUR(item.amount || 0)}</div>
          `;
          listEl.appendChild(row);
        });
        details.innerHTML = '';
        details.appendChild(frag);
      };

      let activeCat = null;

      for(const cat of allowed){
        const value = catTotals[cat] || 0;
        if(value <= 0) continue;
        const chip = document.createElement('div');
        chip.className = 'cat-chip';
        chip.innerHTML = `<strong>${escapeHtml(cat)}</strong>: ${fmtEUR(value)}`;
        chip.addEventListener('click', ()=>{
          const alreadyActive = (activeCat === cat);
          activeCat = alreadyActive ? null : cat;

          Array.from(container.querySelectorAll('.cat-chip')).forEach(el=>{
            el.classList.toggle('active', el === chip && !alreadyActive);
          });

          if(alreadyActive){
            details.innerHTML = '';
          } else {
            renderDetailsFor(cat);
          }
        });
        container.appendChild(chip);
      }
    }

function subscribeMonth(uid, yyyyMM){
      if(unsub) unsub();
      const {start, end} = monthStartEnd(yyyyMM);
      const col = collection(db, 'users', uid, 'entries');
      const qy = query(col, where('date','>=', start), where('date','<', end), orderBy('date','desc'));
      unsub = onSnapshot(qy, (snap)=>{
        const rows = $("rows");
        rows.innerHTML = '';
        let sumIn = 0, sumOut = 0;
        const catTotals = {};
        const catEntries = {};

        snap.forEach((docSnap)=>{
          const d = { id: docSnap.id, ...docSnap.data() };
          const amount = Number(d.amount || 0);

          if(d.kind === 'income'){
            sumIn += amount;
          } else {
            sumOut += amount;
            const raw = (d.cat || '').trim();
            const allowed = [
              'Arbeit',
              'Essen',
              'Sparen',
              'Bücher',
              'Shoppen',
              'Sonstiges',
              'Miete',
              'Gesundheit'
            ];
            const key = allowed.includes(raw) ? raw : 'Sonstiges';
            catTotals[key] = (catTotals[key] || 0) + amount;
            (catEntries[key] = catEntries[key] || []).push(d);
          }

          const tr = rowTemplate(d);
          tr.querySelector('[data-act="edit"]').onclick = ()=>{
            editId = d.id;
            setForm({
              date: d.date?.toDate?.().toISOString().slice(0,10),
              kind: d.kind, cat: d.cat, amount: d.amount, note: d.note
            });
            setModeEditing(true);
            window.scrollTo({top:0,behavior:'smooth'});
          };
          tr.querySelector('[data-act="del"]').onclick = ()=>{
            if(confirm('Diesen Eintrag löschen?')) deleteEntry(uid, d.id);
          };
          rows.appendChild(tr);
        });

        $("sumIn").textContent = fmtEUR(sumIn);
        $("sumOut").textContent = fmtEUR(sumOut);
        const net = sumIn - sumOut;
        $("sumNet").textContent = fmtEUR(net);
        $("sumNet").classList.toggle('positive', net >= 0);
        $("sumNet").classList.toggle('negative', net < 0);

        renderCategoryTotals(catTotals, catEntries);
      });
    }

    function exportCSV(){
      const headers = ['Datum','Typ','Kategorie','Betrag','Notiz'];
      const rows = Array.from(document.querySelectorAll('#rows tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        return [tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText.replace(/\./g,'').replace(/\s€/,'').replace(',', '.'), tds[4].innerText];
      });
      const csv = [headers, ...rows].map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(';')).join('\n');
      const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `budget_${$("month").value||monthOf(new Date())}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // === Auth wiring ===
    $("loginBtn").onclick = async ()=>{
      try{
        await signInWithEmailAndPassword(auth, $("email").value, $("password").value);
        $("auth-error").textContent='';
      }catch(err){ $("auth-error").textContent = err.message; }
    };
    $("signupBtn").onclick = async ()=>{
      try{
        await createUserWithEmailAndPassword(auth, $("email").value, $("password").value);
        $("auth-error").textContent='';
      }catch(err){ $("auth-error").textContent = err.message; }
    };
    $("logout").onclick = ()=> signOut(auth);

    $("save").onclick = ()=> auth.currentUser && saveEntry(auth.currentUser.uid);
    $("cancelEdit").onclick = ()=>{ editId=null; setModeEditing(false); setForm(); };
    $("exportBtn").onclick = exportCSV;

    onAuthStateChanged(auth, user => {
      if(user){
        $("auth").classList.add('hide');
        $("app").classList.remove('hide');
        $("who").textContent = user.email;
        const now = new Date();
        $("month").value = monthOf(now);
        $("date").value = todayISO();
        setModeEditing(false);
        setForm();
        subscribeMonth(user.uid, $("month").value);
      } else {
        if(unsub) unsub();
        $("rows").innerHTML='';
        const catEl = $("catBreakdown");
        if(catEl) catEl.innerHTML = '';
        const detEl = $("catDetails");
        if(detEl) detEl.innerHTML = '';
        $("auth").classList.remove('hide');
        $("app").classList.add('hide');
      }
    });

    $("month").addEventListener('change', ()=>{
      const user = auth.currentUser; if(!user) return;
      subscribeMonth(user.uid, $("month").value);
    });
  </script>
</body>
</html>
